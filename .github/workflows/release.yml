# å‘å¸ƒå·¥ä½œæµ
# æ­¤å·¥ä½œæµç”¨äºè‡ªåŠ¨å‘å¸ƒæ–°ç‰ˆæœ¬çš„æ’ä»¶åˆ° GitHub Releases
# ä»…åœ¨ Lint å·¥ä½œæµæˆåŠŸå®Œæˆåï¼Œä¸”ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
name: Release

# è§¦å‘æ¡ä»¶
on:
  # åœ¨ Lint å·¥ä½œæµæˆåŠŸå®Œæˆåè§¦å‘
  workflow_run:
    workflows: ["Lint"]
    types: [completed]
    branches: ["main"]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º GitHub Release

jobs:
  # å‘å¸ƒä»»åŠ¡
  release:
    name: Create Release
    runs-on: ubuntu-latest

    # ä»…åœ¨ Lint å·¥ä½œæµæˆåŠŸæ—¶è¿è¡Œ
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      # æ£€å‡ºä»£ç 
      # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿ç”Ÿæˆå‘å¸ƒè¯´æ˜
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²è®°å½•

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # æ„å»ºé¡¹ç›®
      # ç”Ÿæˆ main.js æ–‡ä»¶
      - name: Build project
        run: npm run build

      # è¯»å–å½“å‰ç‰ˆæœ¬å·
      # ä» manifest.json ä¸­è¯»å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Read current version
        id: version
        run: |
          VERSION=$(node -p "require('./manifest.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      # æ£€æŸ¥è¯¥ç‰ˆæœ¬æ˜¯å¦å·²ç»å‘å¸ƒ
      # å¦‚æœå·²å‘å¸ƒï¼Œåˆ™è·³è¿‡å‘å¸ƒæµç¨‹
      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/releases/tags/v${VERSION}")
          echo "status_code=$RESPONSE" >> $GITHUB_OUTPUT
          echo "Release check status: $RESPONSE"

      # ä»…å½“ç‰ˆæœ¬æœªå‘å¸ƒæ—¶åˆ›å»ºæ–°çš„ Release
      - name: Create GitHub Release
        if: steps.check_release.outputs.status_code != '200'
        id: create_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Creating release for version: $VERSION"

          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾ï¼ˆç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—ï¼‰
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          else
            echo "No previous tag found, showing all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          fi

          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%an)")

          # åˆ›å»ºä¸´æ—¶çš„å‘å¸ƒè¯´æ˜æ–‡ä»¶
          cat > release_notes.md << 'EOF'
          # Release Notes

          ## Version Information
          - **Version**: ${VERSION}
          - **Release Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Latest Changes
          ${LATEST_COMMIT}

          ## Change Log
          ${CHANGELOG}

          ## Installation

          1. Download the following files:
             - `main.js`
             - `manifest.json`
             - `styles.css`

          2. Copy these files to your Obsidian vault's plugin directory:
             ```
             .obsidian/plugins/auto-download-image/
             ```

          3. Enable the plugin in Obsidian Settings > Community Plugins

          ## Features

          - Automatically detect and download network images in markdown notes
          - Support custom save locations (note folder, vault folder, or Obsidian attachment folder)
          - Support custom naming formats with placeholders
          - Support absolute and relative path options
          - Multi-language support (Chinese/English)
          - Confirmation dialog before processing
          - Comprehensive error handling and notifications
          EOF

          # æ›¿æ¢å˜é‡
          sed -i "s/\${VERSION}/$VERSION/g" release_notes.md
          sed -i "s/\${LATEST_COMMIT}/$LATEST_COMMIT/g" release_notes.md
          sed -i "s/\${CHANGELOG}/$CHANGELOG/g" release_notes.md

          # è¯»å–å‘å¸ƒè¯´æ˜
          RELEASE_BODY=$(cat release_notes.md)
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ–‡ä»¶åˆ° GitHub Release
      # ä½¿ç”¨ softprops/action-gh-release åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      - name: Upload Release Assets
        if: steps.check_release.outputs.status_code != '200'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.create_release.outputs.release_body }}
          files: |
            main.js
            manifest.json
            styles.css
          draft: false
          prerelease: false
          generate_release_notes: false # ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„å‘å¸ƒè¯´æ˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # è¾“å‡ºå‘å¸ƒç»“æœ
      - name: Release result
        if: steps.check_release.outputs.status_code != '200'
        run: |
          echo "âœ… Release v${{ steps.version.outputs.version }} created successfully!"
          echo "ğŸ“¦ Release URL: ${{ steps.create_release.outputs.url }}"
      - name: Skip release message
        if: steps.check_release.outputs.status_code == '200'
        run: |
          echo "â­ï¸ Release v${{ steps.version.outputs.version }} already exists, skipping..."
